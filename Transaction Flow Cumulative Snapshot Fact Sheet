# 交易流程的三个关键结点：下单、支付、确认收货。
# 下单时间为取自订单表的create_time，支付成功时间为取自支付表的callback_time，确认收货时间取自订单流水表的create_time。
# 如果确认收货时间不为null，说明业务流程结束，将其格式化为yyyy-MM-dd格式，作为分区字段dt的值，否则业务流程未结束，dt取值为9999-12-31。
# First day loading
set hive.exec.dynamic.partition.mode=nonstrict; 
insert overwrite table dwd_trade_trade_flow_acc partition(dt) 
select 
    oi.id, 
    user_id, 
    province_id, 
    date_format(create_time,'yyyy-MM-dd'), 
    create_time, 
    date_format(callback_time,'yyyy-MM-dd'), 
    callback_time, 
    date_format(finish_time,'yyyy-MM-dd'), 
    finish_time, 
    original_total_amount, 
    activity_reduce_amount, 
    coupon_reduce_amount, 
    total_amount, 
    nvl(payment_amount,0.0), 
    nvl(date_format(finish_time,'yyyy-MM-dd'),'9999-12-31') 
from 
( 
    select 
        data.id, 
        data.user_id, 
        data.province_id, 
        data.create_time, 
        data.original_total_amount, 
        data.activity_reduce_amount, 
        data.coupon_reduce_amount, 
        data.total_amount 
    from ods_order_info_inc 
    where dt='2022-06-08' 
    and type='bootstrap-insert' 
)oi 
left join 
( 
    select 
        data.order_id, 
        data.callback_time, 
        data.total_amount payment_amount 
    from ods_payment_info_inc 
    where dt='2022-06-08' 
    and type='bootstrap-insert' 
    and data.payment_status='1602' 
)pi 
on oi.id=pi.order_id 
left join 
( 
    select 
        data.order_id, 
        data.create_time finish_time 
    from ods_order_status_log_inc 
    where dt='2022-06-08' 
    and type='bootstrap-insert' 
    and data.order_status='1004' 
)log 
on oi.id=log.order_id; 
# Daily loading
set hive.exec.dynamic.partition.mode=nonstrict; 
insert overwrite table dwd_trade_trade_flow_acc partition(dt) 
select 
    oi.order_id, 
    user_id, 
    province_id, 
    order_date_id, 
    order_time, 
    nvl(oi.payment_date_id,pi.payment_date_id), 
    nvl(oi.payment_time,pi.payment_time), 
    nvl(oi.finish_date_id,log.finish_date_id), 
    nvl(oi.finish_time,log.finish_time), 
    order_original_amount, 
    order_activity_amount, 
    order_coupon_amount, 
    order_total_amount, 
    nvl(oi.payment_amount,pi.payment_amount), 
    nvl(nvl(oi.finish_time,log.finish_time),'9999-12-31') 
from 
( 
    select 
        order_id, 
        user_id, 
        province_id, 
        order_date_id, 
        order_time, 
        payment_date_id, 
        payment_time, 
        finish_date_id, 
        finish_time, 
        order_original_amount, 
        order_activity_amount, 
        order_coupon_amount, 
        order_total_amount, 
        payment_amount 
    from dwd_trade_trade_flow_acc 
    where dt='9999-12-31' 
    union all 
    select 
        data.id, 
        data.user_id, 
        data.province_id, 
        date_format(data.create_time,'yyyy-MM-dd') order_date_id, 
        data.create_time, 
        null payment_date_id, 
        null payment_time, 
        null finish_date_id, 
        null finish_time, 
        data.original_total_amount, 
        data.activity_reduce_amount, 
        data.coupon_reduce_amount, 
        data.total_amount, 
        null payment_amount 
    from ods_order_info_inc 
    where dt='2022-06-09' 
    and type='insert' 
)oi 
left join 
( 
    select 
        data.order_id, 
        date_format(data.callback_time,'yyyy-MM-dd') payment_date_id, 
        data.callback_time payment_time, 
        data.total_amount payment_amount 
    from ods_payment_info_inc 
    where dt='2022-06-09' 
    and type='update' 
    and array_contains(map_keys(old),'payment_status') 
    and data.payment_status='1602' 
)pi 
on oi.order_id=pi.order_id 
left join 
( 
    select 
        data.order_id, 
        date_format(data.create_time,'yyyy-MM-dd') finish_date_id, 
        data.create_time finish_time 
    from ods_order_status_log_inc 
    where dt='2022-06-09' 
    and type='insert' 
    and data.order_status='1004' 
)log 
on oi.order_id=log.order_id; 
